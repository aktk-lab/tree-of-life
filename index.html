<!doctype html>
<html lang="ja"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>ğŸŒ³ ç”Ÿå‘½ã®æ¨¹ â€” Root Dominion v2</title>
<style>
:root{ --cell:84px }
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(800px 500px at 50% -10%,rgba(52,211,153,.10),transparent 60%),linear-gradient(180deg,#081b16,#0e1f28);color:#e9fff6;font:16px/1.6 system-ui,"Noto Sans JP",sans-serif}
h1{font-size:18px;margin:10px 6px;text-align:center;text-shadow:0 0 14px rgba(16,185,129,.35)}
.header{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;padding:8px}
.pill{border:1px solid #1f473f;border-radius:999px;padding:4px 10px;background:#0b2823;font-size:12px}
.btn{padding:9px 12px;border-radius:10px;border:1px solid #1f473f;background:#11443b;color:#e9fff6;cursor:pointer}
.btn:active{transform:translateY(1px)}
input[type=range]{width:150px}
.wrap{max-width:620px;margin:0 auto;padding:10px}
.board{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.cell{width:var(--cell);height:var(--cell);border:1px solid #1f473f;border-radius:12px;background:linear-gradient(180deg,#0f3a32,#0b2b25);display:flex;align-items:center;justify-content:center;font-size:26px;position:relative}
.src{position:absolute;left:6px;top:6px;font-size:16px}
.you{box-shadow:inset 0 0 0 3px rgba(74,222,128,.6)}
.ai{box-shadow:inset 0 0 0 3px rgba(192,132,252,.6)}
.hl{outline:2px solid #60a5fa}
.small{font-size:12px;color:#bbf7d0;max-height:160px;overflow:auto;text-align:left}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:84px;background:#0b2823;border:1px solid #1f473f;color:#e5e7eb;padding:8px 12px;border-radius:10px;opacity:0;transition:opacity .2s, transform .35s;z-index:10}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-8px)}
</style>
</head>
<body>
<h1>ğŸŒ³ ç”Ÿå‘½ã®æ¨¹ â€” Root Dominion v2</h1>
<div class="header">
  <span class="pill">ğŸ§™ ã‚ãªãŸç‚¹:<b id="pS">0</b></span>
  <span class="pill">ğŸ¤– AIç‚¹:<b id="aS">0</b></span>
  <span class="pill">ğŸ”‹ EP:<b id="ep">2</b></span>
  <button id="end" class="btn">â­ï¸ ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
  <button id="new" class="btn">ğŸ” ãƒªã‚»ãƒƒãƒˆ</button>
  <button id="unlock" class="btn">ğŸ”“ å¼·åˆ¶è§£é™¤</button>
  <button id="z-" class="btn">âˆ’</button><input id="z" type="range" min="70" max="110" value="84"><button id="z+" class="btn">ï¼‹</button>
</div>

<div class="wrap">
  <div id="board" class="board"></div>
  <div id="log" class="small"></div>
</div>
<div id="toast" class="toast">text</div>

<script>
(function(){
  "use strict";
  const N=5;
  const SRC_TYPES=['ğŸ’§','ğŸŒ','â›°','ğŸ„','ğŸ”¥',null]; // null=ç©ºåœ°
  const COST_BASE=2;
  const el=id=>document.getElementById(id);
  const tip=t=>{const x=el('toast'); x.textContent=t; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),900);};
  const log=m=>{const L=el('log'); L.innerHTML+=m+'<br>'; L.scrollTop=L.scrollHeight;};
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  let S;

  function reset(){
    // ç›¤ç”Ÿæˆï¼šä¸­å¤®åˆ—ã¯å°‘ã—è³‡æºæ¿ƒã„
    const grid=[...Array(N)].map(()=>[...Array(N)].map(()=>({owner:0,src:pick()})));
    grid[2][0].src=null; grid[2][N-1].src=null; // å¹¹ä½ç½®ã¯ç©º
    S={
      grid, turn:'you', ep:COST_BASE, p:{score:0, trunk:[2,0]}, a:{score:0, trunk:[2,N-1]},
      busy:false
    };
    // å¹¹ã‚’è¨­ç½®
    cell(2,0).owner=1; cell(2,N-1).owner=2;
    renderAll();
    el('log').innerHTML=''; log('â–¶ï¸ é–‹å§‹ï¼šã‚ãªãŸã®ç•ª');
  }
  function pick(){
    // å°‘ã—è³‡æºå¯„ã‚Š
    const r=Math.random();
    if(r<0.18) return 'ğŸ’§';
    if(r<0.33) return 'ğŸŒ';
    if(r<0.46) return 'â›°';
    if(r<0.59) return 'ğŸ„';
    if(r<0.69) return 'ğŸ”¥';
    return null;
  }
  const cell=(r,c)=>S.grid[r][c];

  function neighbors([r,c]){
    return [[r-1,c],[r+1,c],[r,c-1],[r,c+1]].filter(([y,x])=>y>=0&&y<N&&x>=0&&x<N);
  }
  function renderAll(){
    el('pS').textContent=S.p.score; el('aS').textContent=S.a.score; el('ep').textContent=S.ep;
    const B=el('board'); B.innerHTML='';
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const d=document.createElement('div'); d.className='cell';
        const cc=cell(r,c);
        if(cc.owner===1) d.classList.add('you'); else if(cc.owner===2) d.classList.add('ai');
        d.dataset.r=r; d.dataset.c=c;
        d.innerHTML=`<div class="src">${cc.src?cc.src:''}</div>${cc.owner===1?'ğŸŸ¢':cc.owner===2?'ğŸŸ£':''}`;
        B.appendChild(d);
      }
    }
    highlight();
  }
  function highlight(){
    document.querySelectorAll('.hl').forEach(n=>n.classList.remove('hl'));
    if(S.turn!=='you') return;
    const frontier = frontierCells(1);
    frontier.forEach(([r,c])=>{
      const d=document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
      if(d) d.classList.add('hl');
    });
  }
  function frontierCells(owner){
    // è‡ªåˆ†ã®æ ¹ã«éš£æ¥ã™ã‚‹ç©ºããƒã‚¹
    const f=[];
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      if(cell(r,c).owner===owner){
        for(const nb of neighbors([r,c])){
          const t=cell(...nb);
          if(t.owner===0 && !includesCoord(f, nb)) f.push(nb);
        }
      }
    }
    return f;
  }
  function includesCoord(list,[r,c]){ return list.some(([y,x])=>y===r&&x===c); }

  function grow(owner, to){
    // ã‚³ã‚¹ãƒˆè¨ˆç®—
    let cost=COST_BASE;
    const s = cell(...to).src;
    if(s==='ğŸŒ') cost=Math.max(1,cost-1);
    if(s==='ğŸ’§') S.ep+=1;        // å³æ™‚ãƒœãƒ¼ãƒŠã‚¹
    if(s==='ğŸ”¥') { if(owner===1) S.p.score=Math.max(0,S.p.score-1); else S.a.score=Math.max(0,S.a.score-1); } // ç½°
    if(S.ep<cost){ tip('EPä¸è¶³'); return false; }
    S.ep-=cost;
    cell(...to).owner = owner;
    if(s==='â›°'){ /*é˜²å¾¡ï¼šä»Šå›ã¯è¦‹ãŸç›®ã®ã¿*/ }
    // é€£çµ3ã§æœå®Ÿâ­
    const gained = checkFruit(owner);
    if(gained>0){
      if(owner===1) S.p.score+=3; else S.a.score+=3;
      log(`${owner===1?'ã‚ãªãŸ':'AI'} â­ æœå®Ÿ +3`);
    }
    // èŒç³¸ï¼šé€£çµãƒœãƒ¼ãƒŠã‚¹
    if(s==='ğŸ„'){
      const len = longestChain(owner);
      if(owner===1) S.p.score += 1; else S.a.score += 1;
      log(`${owner===1?'ã‚ãªãŸ':'AI'} ğŸ„ é€£çµãƒœãƒ¼ãƒŠã‚¹ +1ï¼ˆé€£çµé•·=${len}ï¼‰`);
    }
    return true;
  }

  function checkFruit(owner){
    // ç›´ç·š3é€£çµãŒç”Ÿã¾ã‚ŒãŸã‹
    let made=0;
    // æ¨ª
    for(let r=0;r<N;r++){
      for(let c=0;c<=N-3;c++){
        if(cell(r,c).owner===owner && cell(r,c+1).owner===owner && cell(r,c+2).owner===owner){
          made++;
        }
      }
    }
    // ç¸¦
    for(let c=0;c<N;c++){
      for(let r=0;r<=N-3;r++){
        if(cell(r,r?c:c).owner===owner && cell(r+1,c).owner===owner && cell(r+2,c).owner===owner){
          made++;
        }
      }
    }
    return made;
  }

  function longestChain(owner){
    // BFSã§æœ€å¤§é€£çµé•·
    const seen=[...Array(N)].map(()=>Array(N).fill(false));
    let best=0;
    for(let r=0;r<N;r++)for(let c=0;c<N;c++){
      if(cell(r,c).owner!==owner || seen[r][c]) continue;
      let q=[[r,c]]; seen[r][c]=true; let cnt=0;
      while(q.length){ const [y,x]=q.shift(); cnt++;
        for(const nb of neighbors([y,x])){
          if(!seen[nb[0]][nb[1]] && cell(...nb).owner===owner){ seen[nb[0]][nb[1]]=true; q.push(nb); }
        }
      }
      best=Math.max(best,cnt);
    }
    return best;
  }

  function endTurn(){
    if(S.busy) return; S.busy=true;
    try{
      // åç©«ï¼šé€£çµé•·ã‚’å¾—ç‚¹åŒ–ï¼ˆå°ã•ã‚ï¼‰
      const add = Math.max(0, longestChain(1)-1);
      if(add>0){ S.p.score+=add; log(`ğŸŒ¾ åç©«ï¼š+${add}`); }
      // å‹åˆ©åˆ¤å®š
      if(S.p.score>=20 || S.a.score>=20) return finish();
      // AIã¸
      S.turn='ai'; S.ep=COST_BASE;
      renderAll();
      setTimeout(aiStep, 300);
    } finally { /* busyã¯AIå´ã§ã‚¯ãƒªã‚¢ */ }
  }

  function finish(){
    const res = S.p.score>=20 && S.p.score>=S.a.score ? 'å‹åˆ©ï¼' : 'æ•—åŒ—â€¦';
    alert(`å¯¾æˆ¦çµ‚äº†ï¼š${res}\nã‚ãªãŸ ${S.p.score} / AI ${S.a.score}`);
    S.busy=false;
  }

  function aiStep(){
    // EPã‚’ä½¿ã„åˆ‡ã‚‹ã¾ã§æˆé•·ï¼ˆæœ€å¤§3å›ï¼‰
    let steps=0;
    while(S.turn==='ai' && S.ep>0 && steps<6){
      const cand = frontierCells(2);
      if(cand.length===0) break;
      // è©•ä¾¡ï¼šè³‡æºä¾¡å€¤ + è‡ªé€£çµæœŸå¾… âˆ’ ç›¸æ‰‹å¦¨å®³ä¾¡å€¤ã®ä¸€éƒ¨
      let best=null;
      for(const pos of cand){
        const score = evalMove(2,pos);
        if(!best || score>best.sc) best={pos,sc:score};
      }
      if(!grow(2,best.pos)) break;
      steps++;
    }
    // åç©«
    const add = Math.max(0, longestChain(2)-1);
    if(add>0){ S.a.score+=add; log(`ğŸ¤–ğŸŒ¾ åç©«ï¼š+${add}`); }
    if(S.p.score>=20 || S.a.score>=20){ S.busy=false; return finish(); }
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
    S.turn='you'; S.ep=COST_BASE; S.busy=false; renderAll(); log('ğŸªµ ã‚ãªãŸã®ç•ª');
  }

  function evalMove(owner,pos){
    const s = cell(...pos).src;
    const resVal = (s==='ğŸ’§'?1.2 : s==='ğŸŒ'?0.8 : s==='â›°'?0.6 : s==='ğŸ„'?1.4 : s==='ğŸ”¥'?-1.2 : 0.5);
    // é•·ãç¹‹ãŒã‚Šãã†ãªæ–¹å‘ã‚’å¥½ã‚€ï¼ˆè¿‘å‚ã«è‡ªæ ¹ãŒå¤šã„ã»ã©+ï¼‰
    let near=0;
    for(const nb of neighbors(pos)){ if(cell(...nb).owner===owner) near++; }
    // ç›¸æ‰‹ã®å‰é€²ãƒ©ã‚¤ãƒ³ã‚’å¡ãï¼ˆç›¸æ‰‹ãŒéš£æ¥ã—ã¦ã„ã‚‹ãªã‚‰+ï¼‰
    let block=0;
    for(const nb of neighbors(pos)){ if(cell(...nb).owner=== (owner===1?2:1)) block+=0.6; }
    return resVal + near*0.8 + block*0.6;
  }

  // ===== UI =====
  el('board').addEventListener('click',(e)=>{
    if(S.busy || S.turn!=='you') return;
    const d=e.target.closest('.cell'); if(!d) return;
    const r=+d.dataset.r, c=+d.dataset.c;
    // è‡ªæ ¹ã«éš£æ¥ï¼†ç©ºãã‹ï¼Ÿ
    const fr=frontierCells(1).some(([y,x])=>y===r&&x===c);
    if(!fr){ tip('ãã“ã«ã¯ä¼¸ã°ã›ã¾ã›ã‚“'); return; }
    if(grow(1,[r,c])){ renderAll(); }
  });
  el('end').onclick=()=>endTurn();
  el('new').onclick=()=>reset();
  el('unlock').onclick=()=>{ S.busy=false; tip('ğŸ”“è§£é™¤'); };

  // ã‚ºãƒ¼ãƒ 
  const zr=el('z');
  const apply=(v)=>{
    const x=clamp(+v,70,110); zr.value=x; document.documentElement.style.setProperty('--cell',x+'px'); renderAll();
  };
  el('z-').onclick=()=>apply(zr.value-6);
  el('z+').onclick=()=>apply(+zr.value+6);
  zr.oninput=()=>apply(zr.value);

  window.onload=()=>{ apply(zr.value); reset(); };
})();
</script>
</body>
</html>
